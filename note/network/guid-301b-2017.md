### About
F5 Certified! Technology Specialist, Local Traffic Manager (F5-CTS, LTM)

> v2017 by Edward

> current exam based on version v11.5

> https://mermaidjs.github.io/flowchart.html

> to support flowchart on http://note.youdao.com ,remove "mermaid"

##### Reading List
- BIG-IP® Local Traffic Manager™: Concepts //pdf
- Certification Study Guide 301b //pdf
- BIG-IP_Local_Traffic_Manager__Implementations //pdf

# Section1:Troubleshoot basic virtual server connectivity issues

## Objective: Profile
- [x] [Profile Concepts](https://support.f5.com/kb/en-us/products/big-ip_ltm/manuals/product/ltm-concepts-11-2-1/ltm_understanding_profiles.html)

### Note

> Stream proﬁle: 

    -with HTTP profile    ---> search and replace only on HTTP payload
    -without HTTP profile ---> search and replace on tcp payload
    
> TCP window & buffer:
    
    -max-non-scaled window = 64k
    -proxy buffer high = 131072 (lan-opt:low=98,304 wan-opt:low=131,072)
    
> OneConnect & HTTP:
    
    - SOL6997 / SOL5911 / SOL7208
    -works with keep-alive enabled by default in HTTP/1.1
    -without OneConnect: LB once per tcp connection
    -with OC http/non-http-tcp: ltm is able to proc each request
    -source maskes
    -If SNAT is conﬁgured, the BIG-IP system performs SNAT address translation on the source IP address, 
    and then applies the OneConnect source mask to the translated SNAT IP address to determine whether it is eligible to reuse an existing idle connection.
    
> Deferred Accecpt Tcp profile:
    
    -option speciﬁes that the system does not dedicate resources to the connection until the system has received the data packet from the client.
    This setting is useful when negotiating 3-way handshake denial-of-service attacks.
    -disabled by default.
    -not compatible with virtual servers (such as FTP, POP3, and SMTP) for applications that either require *dialog or present a banner*. 
    


## Objective: Upgrade and recovery

> Explain how to upgrade a vCMP environment
    
    -vCMP guest states
        *configured: not runnig,no resource, de-allocate cpu and memery
        *provisioned: allocate resource,create virtual disk
        *deployed: install,run, immediately propagate: hostname,cluster ip, allowed vlans
    
    -dirs:
        /shared/images

> Install sw

    -tmsh install sys software image [image name] volume [volume name]
    -or from web

> *A Sync-Failover device group can support a maximum of 15 traffic groups.*

> SCF and UCS files
```
-dir: /var/local/scf,/var/local/ucs
-Beginning in BIG-IP 11.0.0, when installing a UCS configuration archive, the BIG-IP system restores the full configuration.
-ucs: usrname/passwd,ssl private keys,critical sys files
-tmsh [load | save] /sys ucs <filename> [no-license | no-private-key]
    //on 6400/8400/8800: run /util bash ; keyswap.sh sccp;exit;reboot
-0107102b:3: Master Key decrypt failure - decrypt failure - final

```

## Objective: Alert
    
> Enterprise Manager:

    -an appliance that helps you streamline the administrative tasks associated with managing multiple network devices.
    -tasks include: performance monitoring, software installation and upgrades, configuration archival and restoration, certificate monitoring, security policy management, software image storage, and user account management.
    -em local&remote events:...
    
    -Enterprise Manager allows administrators to establish baseline application usage 
     and generate an alert if an administratively set threshold for the application is exceeded


> AVR Alerting:

> Remote syslogging:

    creating a pool of servers, 
    creating a custom request logging profile that determines log content and references the log server pool, 
    and then assigning the profile to each virtual server that you create to process application traffic.

>Alert configuration files:
    
    -pre-configured snmp traps: /etc/alertd/alert.conf
    -user-defined SNMP traps: /config/user_alert.conf
    
>log test:
    
    logger -p <facility>.<level> “<alert code>:<log level>: “<Syslog Message String>”


| Log level | Description                      | Corresponding syslog level |
| --------- | -------------------------------- | -------------------------- |
| 0         | System is unusable               | emerg                      |
| 1         | Action must be taken immediately | alert                      |
| 2         | Critical Conditions              | crit                       |
| 3         | Error Conditions                 | err                        |
| 4         | Warning Conditions               | warning                    |
| 5         | Normal but significant condition | notice                     |
| 6         | Informational                    | info                       |
| 7         | Debug-level messages             | debug                      |



# Section2: Identify and resolve application issues

## Objective: iRule

- [ ] [Wiki: iRules API](https://devcentral.f5.com/wiki/iRules.BasicRuleElements.ashx)

> irule events

```
# http events
HTTP_CLASS_FAILED - Triggered when an HTTP request is made to a virtual server with at least one HTTP class configured. and the request does not match the filters of any HTTP class.
HTTP_CLASS_SELECTED - Triggered when an HTTP request matches an HTTP class.
HTTP_DISABLED - triggered when HTTP is disabled
HTTP_PROXY_CONNECT - triggered when proxy chaining via use of the HTTP_PROXY_CONNECT profile
HTTP_PROXY_REQUEST - Triggered when a virtual server has proxy-mode explicit
HTTP_PROXY_RESPONSE - triggered when the response from the remote HTTP proxy is received
HTTP_REJECT - triggered when HTTP aborts the connection
HTTP_REQUEST - Triggered when the system fully parses the complete client HTTP request headers.
HTTP_REQUEST_DATA - Triggered when an HTTP::collect command has collected the specified amount of request data.
HTTP_REQUEST_SEND - Triggered immediately before an HTTP request is sent to the server-side TCP stack.
HTTP_RESPONSE - Triggered when the system parses all of the response status and header lines from the server response.
HTTP_RESPONSE_CONTINUE - Triggered whenever the system receives a 100 Continue response from the server.
HTTP_RESPONSE_DATA - Triggered when an HTTP::collect command has collected the specified amount of response data.
HTTP_REQUEST_RELEASE - Triggered when the system is about to release HTTP data on the serverside of the connection.
HTTP_RESPONSE_RELEASE - Triggered when the system is about to release HTTP data on the clientside of the connection.

#ip events
CLIENT_ACCEPTED - Triggered when a client has established a connection.
CLIENT_CLOSED - This event is fired at the end of any client connection. regardless of protocol.
CLIENT_DATA - Triggered each time new data is received from the client while the connection is in “collect” state.
CLIENTSSL_DATA - Triggered each time new SSL data is received from the client while the connection is in “collect” state.
SERVER_CLOSED - This event is triggered when the server side connection closes.
SERVER_CONNECTED - Triggered when a connection has been established with the target node.
SERVER_DATA - Triggered when new data is received from the target node after TCP::collect command has been issued.
SERVERSSL_DATA - Triggered when new SSL data is received from the target node after SSL::collect command has been issued.

#tcp events (ip events included)
USER_REQUEST - triggered by command TCP::notify request.
USER_RESPONSE - Triggered by command TCP::notify response


```

> The syntax for the log is:

    -log [<facility>.<level>] <message>
    -facility: “local0”, “local1”, “local2”, “local3”, “local4”, “local5”, “local6”, “local7”
    -level: “alert”, “crit”, “debug”, “emerg”, “err”, “error”, “info”, “none”, “notice”,“panic”, “warn”, “warning”
    -default: “local0” and “error” (local0.)

> AVR:
    
    -avr to trace app traffic
    -create a Analytics profile for vs/app
    
> Browser requirements to obtain page load times

    -Supports Navigation Timing by W3C
    -Accepts cookies from visited application sites
    -Enables JavaScript for the visited application sites

## Objective: HTTP/HTTPS

> Response Code

    1xx: Informational - Request received, continuing process
    
    2xx: Success - The action was successfully received, understood, and accepted
    
    3xx: Redirection - Further action must be taken in order to complete the request
    
    4xx: Client Error - The request contains bad syntax or cannot be fulfilled
    
    5xx: Server Error - The server failed to fulfill an apparently valid request

> HTTP Method
    
    GET / HEAD / POST / TRACE / PUT / DELETE HEAD

> HTTP HEADERS

    1. HTTP version (HTTP/1.0 or HTTP/1.1)
    
    2. Accept-Encoding: gzip, deflate (not include in 1.0 by default)
    
    3. Connection: Keep-Alive (not include in 1.0 by default)
    
    4. If-* headers
    
    5. Cache-Control or Pragma no-cache



```
GET /home.html HTTP/1.1
Host: example1.org

If the URL references a port other than the default (TCP port 80), this is also given in the Host header.
Clearly, since HTTP/1.0 clients will not send Host headers, HTTP/1.1 servers cannot simply reject all
messages without them. However, the HTTP/1.1 specification requires that an HTTP/1.1 server must reject
any HTTP/1.1 message that does not contain a Host header.
```

> ssldump utility

[packet trace with ssldump](https://support.f5.com/csp/article/K10209)

```
//To create a pre-master secret key log file, use the following ssldump syntax:

ssldump -r /path/to/capture_file -k /path/to/private_key -M /path/to/premaster-
key_log_file

//For example, the following ssldump command reads the www-ssl-client1.cap capture file using the test. org key file to decrypt the session, and creates the PMS log file called client1.pms:

ssldump -r /var/tmp/www-ssl-client1.cap -k /config/filestore/files_d/Common_d/
certificate_key_d/\:Common\:test.org.key_1 -M /var/tmp/client1.pms


To print the decrypted application data, 
use the -k option to specify the path and name of the file
containing the server’s private key.

For example:
ssldump -Aed -nr /var/tmp/www-ssl-client.cap -k /config/ssl/ssl.key/www-ssl.key

Note: In BIG-IP 11.x, the SSL profile keys are stored in the /config/filestore/files_d/<partition_name>_d/certificate_key_d/ directory.
```

> Http Chunking

- [ ] [http chunking overview](https://support.f5.com/csp/article/K5379)
    
    Some operations involve modifying content, such as adding content using an iRule, or applying compression.
    These operations need to first remove chunking (unchunk), perform the operation, and optionally reapply chunking (rechunk) to the new content.
    
    unchunck / rechunk / selective / preserve
    
    In HTTP/1.1, a chunked message may include a trailer after the final chunk. 
    A trailer is simply a set of one or more header fields.

> Persistence Profiles 

```
The persistence types that you can enable using a persistence profile are:

• Cookie persistence
Cookie persistence uses an HTTP cookie stored on a client’s computer to allow the client to reconnect
to the same server previously visited at a web site.

• Destination address affinity persistence
Also known as sticky persistence, destination address affinity persistence supports TCP and UDP
protocols, and directs session requests to the same server based solely on the destination IP address
of a packet.

• Hash persistence
Hash persistence allows you to create a persistence hash based on an existing iRule.

• Microsoft Remote Desktop Protocol persistence
Microsoft Remote Desktop Protocol (MSRDP) persistence tracks sessions between clients and servers
running the Microsoft Remote Desktop Protocol (RDP) service.

• SIP persistence
SIP persistence is a type of persistence used for servers that receive Session Initiation Protocol (SIP)
messages sent through UDP, SCTP, or TCP.

• Source address affinity persistence
Also known as simple persistence, source address affinity persistence supports TCP and UDP
protocols, and directs session requests to the same server based solely on the source IP address
of a packet.

• SSL persistence
SSL persistence is a type of persistence that tracks non-terminated SSL sessions, using the SSL
session ID. Even when the clients IP address changes, Local Traffic Manager still recognizes the
connection as being persistent based on the session ID. Note that the term non-terminated SSL
sessions refers to sessions in which Local Traffic Manager does not perform the tasks of SSL
certificate authentication and encryption/re-encryption.

• Universal persistence
Universal persistence allows you to write an expression that defines what to persist on in a packet.
The expression, written using the same expression syntax that you use in iRules, defines some
sequence of bytes to use as a session identifier.
```

> OneConnect profile and session persistence
pass

> Match Across Services setting

```mermaid
graph LR;
    Client-->|req1-initial|VS-addr1:http;
    Client-->|req2|VS-addr1:ssl;
    VS-addr1:http-->pool1(pool1:node1:80, node2:80);
    VS-addr1:ssl-->pool2(pool2:node1:443, node2:443);
    pool1-->|80|node1
    pool2-->|443|node1
    
```

In order for the Match Across Services setting to be effective, 
virtual servers that use the **same virtual address**, as well as those that use SSL persistence,
should include the **same node addresses** in the virtual server mappings. 

apply to cookied hash only

> Match Across Virtual Servers setting
```mermaid
graph LR;
    Client-->|req1-initial|VS-addr1:http;
    Client-->|req2|VS-addr2:ssl;
    VS-addr1:http-->pool1(pool1:node1:80, node2:80);
    VS-addr2:ssl-->pool2(pool2:node1:443, node2:443);
    pool1-->|80|node1
    pool2-->|443|node1
    
```

In order for this setting to be effective, virtual servers that use pools with TCP or SSL
persistence should include the **same member addresses** in the virtual server mappings.

apply to cookied hash only

> Match Across Pools setting

When you enable the Match Across Pools setting, Local Traffic Manager can use any pool that contains a
given persistence record. The default is disabled (cleared).

Enabling this setting can cause Local Traffic Manager to direct client traffic to a pool other
than that specified by the virtual server.

apply to cookied hash only

> Tcpdump & ssldump

[K13637: Capturing internal TMM information with tcpdump](https://support.f5.com/csp/article/K13637)

[K411](https://support.f5.com/csp/article/K411)
[K10209](https://support.f5.com/csp/#/article/K10209)

```
tcpdump -s0 -ni /partition/<vlan>:<noiseamplitude> -w <path to output file> <filter options>

For example:

tcpdump -s0 -ni internal:nnn -w /var/tmp/my_output_file.dmp

The tcpdump utility does not capture traffic when run from a non-default route domain:
rdsh 0
```

> Tcpdump & snat

Starting in v11.2, there is an undocumented feature that can help. It’s a new “-p” flag to
dump on “peer” flows in tcpdump.
```
tcpdump -ni 0.0:nnnp -s 0 host client-ip -w /var/tmp/traffic_from_client.pcap
```

> TCP RST

SOL9812: [K9812: Overview of BIG-IP TCP RST behavior](https://support.f5.com/csp/article/K9812?sr=46608010)

 
https://support.f5.com/csp/article/K5670


##### *global setting
```
Adaptive reaping may be activated by events or conditions that increase memory utilization, including but not limited to the following:

- Denial-of-service (DoS) attacks

An attacker attempting to increase BIG-IP memory utilization by sending a large number of connections over a short period of time can cause the system to enter aggressive reaping mode.

- RAM Cache memory allocation

Allocating too much system memory for the RAM Cache feature can potentially cause the system to enter aggressive reaping mode to free memory.

- Memory leaks

If a memory leak persists for an extended period of time, the system may enter aggressive reaping mode to free memory.

These events are marked in the /var/log/ltm file with messages similar to the following examples:

tmm tmm[<PID>]: 011e0002:4: sweeper_update: aggressive mode activated. (117504/138240 pages)

tmm tmm[<PID>]: 011e0002:4: sweeper_update: aggressive mode deactivated. (117503/138240 pages)

The BIG-IP system also generates the following SNMP trap when this event occurs:

bigipAggrReaperStateChange .1.3.6.1.4.1.3375.2.4.0.22

You can determine the percentage of memory being used by each TMM process on the BIG-IP system using the following command, appropriate for your version:

BIG-IP 10.x and 11.5.x

tmctl -d blade tmm/pagemem
tmctl -d blade tmm/pagemem | awk '/page/ {print $0 ,$2*100/($3+$2)"%"}'

Depending on the BIG-IP platform, the command output may appear similar to the following example:


name         used      avail
------- --------- ----------
pagemem 936478624 1103101952

When you have obtained the figures as described, use the following formula for calculation:

(used / avail) * 100 = percentage used

Using the previous example, the percentage of memory calculated would be as follows:

(936478624 / 1103101952) * 100 = 84.89 percent
```

##### *Virtual servers
```
Virtual server connection limits
When a virtual server connection limit is configured, and the maximum number of concurrent connections is exceeded for the virtual server, the BIG-IP system sends a TCP RST packet in response to connection attempts. The TCP RST packet is sent on the client side of the connection, and the source IP address of the reset is the relevant virtual server IP address.
```

##### *Reject virtual servers
```
A Reject virtual server always sends a TCP RST packet in response to a connection attempt. The TCP RST packet is sent on the client side of the connection, and the source IP address of the reset is the relevant virtual server IP address.

Note: For more information, refer to K8082: Overview of TCP connection setup for BIG-IP LTM virtual server types.
```

##### *Pools
```
No available pool members
When all pool members are unavailable due to being disabled, forced offline, or down, the BIG-IP RST behavior varies slightly depending on the virtual server type. 
- If the virtual server references a TCP profile (Standard virtual server type), the system allows the three-way TCP handshake to complete before sending the TCP RST to the client. 
- If the virtual server references a FastL4 profile, the system sends a TCP RST packet in response to a connection attempt. The TCP RST packet is sent on the client side of the connection, and the source IP address of the reset is the relevant virtual server IP address.
```
##### *Pool member or node connection limits
```
When a pool member or node connection limit is configured, and the maximum number of concurrent connections is exceeded for the pool member or node, the BIG-IP system resets the connection attempt. The TCP RST packet is sent on the client side of the connection, and the source IP address of the reset is the relevant virtual server IP address.

Note: For more information, refer to K9849: The BIG-IP system sends a TCP RST packet when the system reaches a pool member or node connection limit.
```
##### *Profiles
```
Protocol profile idle timeouts (if the Reset On Timeout setting is enabled)
The BIG-IP system tracks connection flows by adding an entry to the connection table. When the connection flow becomes idle, the BIG-IP system starts a timer and closes the connection with a TCP RST packet when the connection reaches the idle session timeout. The TCP RST packet is sent on the client and server side of the connection, and the source IP address of the reset is the relevant virtual server IP address. If the connection flow is associated with multiple profiles that specify different idle session timeout values, the connection will be closed when the idle time reaches the smaller value.

Note: For more information, refer to K7606: Overview of BIG-IP idle session time-outs and K7166: Changing the idle timeout for a protocol profile.
```
##### *Maximum Segment Retransmission =8
```
The BIG-IP LTM system resets TCP connections after sending eight retransmissions for a connection. The TCP RST packet is sent on the client side of the connection, and the source IP address of the reset is the relevant virtual server IP address.

Note: For more information, refer to K14813: Detecting and mitigating DoS/DDoS attacks (11.4.x - 12.x) and K7381: The BIG-IP resets TCP connections after sending eight retransmissions for a connection.
```
##### *Maximum SYN Retransmissions =3
```
The BIG-IP LTM system resets TCP connections after sending three SYN retransmissions for a connection. The TCP RST packet is sent on the client side of the connection, and the source IP address of the reset is the relevant virtual server IP address.

Note: For more information, refer to K14813: Detecting and mitigating DoS/DDoS attacks (11.4.x - 12.x), and K10372: BIG-IP LTM resets TCP connections after sending three SYN retransmissions for a connection.
```
##### *SNATs
```
Unacknowledged SYN requests for SNAT objects
The BIG-IP LTM system terminates a SNAT flow with a TCP RST packet after processing three unacknowledged SYN requests for the connection.

Note: For more information, refer to K7829: Nascent SNAT connections are reset when the retransmission backoff time exceeds the TCP Handshake Timeout.

Idle connection timeouts for SNAT objects
When a SNAT connection flow becomes idle and reaches the idle session timeout, the BIG-IP system closes the connection with a TCP RST packet.

Note: For more information, refer to K7606: Overview of BIG-IP idle session time-outs.
```
##### *SNAT port exhaustion
```
A SNAT supports approximately 64,000 concurrent connections per destination IP. A high volume of requests can exceed the 64,000 connection limit and result in TCP port exhaustion.

Note: For more information, refer to *[K7820: Overview of SNAT features.]*

Note: Connections processed by a SNAT object are also frequently processed by a virtual server object. The source address of the TCP RST packet will vary depending on whether the connection is processed by a SNAT object alone, or whether the connection is also processed by a virtual server.
```
##### *Monitors
```
BIG-IP health monitors
Certain BIG-IP monitors may use a TCP RST packet to close the monitor connection when the remote service returns a prompt. For example, the tcp monitor initiates a TCP connection to the remote service. If the service returns a prompt after the connection is established (for example, FTP or SSH), the tcp monitor considers the service to be up, and sends a TCP RST packet to the service.

The following BIG-IP monitor types may use a TCP RST packet to close the monitor connection quickly after receiving matched content:

The tcp_half_open monitor performs a simple check on the pool member service by sending a TCP SYN packet to the service port. When the monitor receives the SYN-ACK packet from the pool member, the monitor considers the service to be up, and sends a TCP RST packet to the service instead of completing the three-way handshake. The TCP RST packet is typically sent on the server side of the connection, and the source IP address of the reset is the relevant self IP address of the VLAN.
The HTTP monitor may send TCP reset packets to close the monitor connection as soon as the health check receive string is matched, even if the BIG-IP system has not yet received the entire object that was requested in the HTTP monitor send string. Closing the monitor connection in this way saves BIG-IP system resources.
iRules
```
##### *iRules commands
```
An iRule can be configured to close TCP connections using a TCP RST packet. For example, the reject iRule command closes the TCP connection by sending a TCP RST packet to the TCP peer, as appropriate, for the protocol. The TCP RST packet is sent on the client side of the connection, and the source IP address of the reset is the relevant BIG-IP LTM object address with which the iRule is associated.

Note: For more information, refer to the DevCentral site. A DevCentral login is required to access this content.
```
##### *Packet filters
```
Packet filter rules
A packet filter configured with an action of Reject for certain TCP traffic will force the system to drop the packet, and also send a TCP RST packet to the sender.
```

> CMP

Even if CMP is enabled on a virtual server, the BIG-IP system demotes a virtual server with incompatible
features from CMP processing. This means it will run slower due to the CMP feature being turned off.
If the virtual server has been demoted, the CMP Mode line of the 
```
TMSH show ltm virtual <virtual_server_name> command 
```
reports none, disable, or single to indicate that CMP has been demoted for the virtual
server.

> Extended Application Verification Monitor (EVA)

An EAV monitor is an executable script located on the BIG-IP’s file system 

(usually under /usr/bin/monitors)

that is executed at regular intervals by the bigd daemon and reports its status.

*Any output to stdout (standard output) from the script will mark the pool member “up”.*

```
#!/bin/bash

# $1 = node IP
# $2 = node port
# $3 = hostname to resolve

[[ $# != 3 ]] && logger -p local0.error -t ${0##*/} -- "usage: ${0##*/} <node IP> <node port> <hostname to resolve>" && exit 1

node_ip=$(echo $1 | sed 's/::ffff://')

dig +short @$node_ip $3 IN A &> /dev/null

[[ $? == 0 ]] && echo “UP”
```

> Monitor

- [x] monitor, transparent, alias
- [x] [Monitor Concepts](https://support.f5.com/kb/en-us/products/big-ip_ltm/manuals/product/ltm-monitors-reference-11-5-0/1.html)

# Section3: Identify and resolve LTM device issues

[K14800: Order of precedence for virtual server matching](https://support.f5.com/csp/article/K14800)
```
Destination address
Source address
Service port
```

> 01010029:5: Clock advanced by <number> ticks

If the error message is logged continually, the system is likely experiencing resource issues that may be
caused by one or more of the following factors:

- Memory paging, I/O operations, or other events causing TMM to lose CPU time
- Complex iRule configurations
- Large complex configurations, such as those containing numerous Secure Socket Layer (SSL) profiles with
- SSL certificates or keys
- Certain administrative operations, such as dumping large numbers of connections or persistence entries
- Listing large ARP tables using commands such as TMSH show net arp

refer to SOL10472: Intense disk drive I/O
activity may cause essential BIG-IP processes to be swapped out or descheduled.


> Issues that may cause network failover problems

- Busy or blocked TMM daemon : 01010029:5: Clock advanced by <number> ticks
    
    To limit network failover disruptions related to the previous scenario, implement one or more of the following
options:
    
    - Configure redundant network failover channels (use the management network, in addition to a TMM
network)
    - Configure hardwired failover (appliance platforms)
    - Add additional failover unicast addresses for device group members
    - Increase the network failover timeout

- VIPRION blade failure
- Failover events causing VLAN disruption

To Workround:
  
    Configure network failover for VIPRION systems  
    Configure redundant network failover channels (use the management network, in addition to a TMM network)
    Configure hardwired failover (appliance platforms)
    Add additional failover unicast addresses for device group members
    Increase the network failover timeout
    Configure gateway failsafe ？

> Port Lock

```
UDP 1026 network failover

modify /net self <self_ip> allow-service <option>
modify /net self 10.10.10.1 allow-service default
```

> When configuring VLAN failsafe for a VLAN, you should consider the following factors:

• VLAN failsafe configuration is local to the BIG-IP system and is not a shared configuration that is
synchronized between high-availability systems during ConfigSync operations. As a result, you must
define VLAN failsafe on all BIG-IP units in a high-availability system.

• To avoid unnecessary failover, the VLAN failsafe timeout value should be set to a value larger than the
number of seconds that the neighboring links take to initialize. An unnecessary failover may cause
more disruption than a brief flap in network connectivity. Setting the timeout too low can cause system
and network instability issues if both members of the redundant system experience intermittent
connectivity.

• If you enable VLAN failsafe on a VLAN with nodes that do not respond consistently to the standard
VLAN failsafe probes, the BIG-IP high-availability systems can experience unintended VLAN failsafe
events.

• Unwanted VLAN failsafe events can occur if VLAN failsafe is enabled on a VLAN with no default
gateway or pool members, and the VLAN contains only devices that do not respond to ARP requests,
ICMPv6 neighbor discovery probes, or multicast pings. To help prevent this behavior, you can assign a
health monitor to at least one node on that VLAN. This practice helps to consistently populate the ARP
tables on the BIG-IP high-availability systems, and give a more accurate view of VLAN availability.
F5 STUDY GUIDE 301b – BIG-IP LTM Technology Specialist: Maintain and Troubleshoot
184

• If you set the VLAN failsafe action to Restart All or Reboot when a low failsafe timeout value is
configured, the BIG-IP system may enter a cycle of restarting services or rebooting until VLAN failsafe
is disabled. This behavior may occur when the timeout value is set too low and the interfaces are not
available after a reboot or restart due to a Spanning Tree update or because LACP enabled trunks
have not initialized. To prevent this behavior from occurring, do not set the VLAN failsafe timeout value
below the recommended value of 90 seconds.

• Testing the VLAN failsafe feature for an HA redundant pair by removing all nodes from the VLAN may
not result in a VLAN failsafe action being triggered. If the VLAN being tested is used for network failover
and/or state mirroring, the traffic generated between the redundant BIG-IP systems is sufficient to
prevent VLAN failsafe from being triggered.


> serial and network failover

Network failover is based on heartbeat detection where the system sends heartbeat packets over the internal
network.

Hardwired failover is also based on heartbeat detection, where one BIG-IP system continuously sends voltage
to another. If a response does not initiate from one BIG-IP system, failover to the peer occurs in less than one
second. When BIG-IP redundant devices connect using a hardwired failover cable, the system automatically
enables hardwired failover.

The maximum hardwired cable length is 50 feet. Network failover is an option if the distance between two
BIG-IP systems exceeds the acceptable length for a hardwired failover cable.


Certain statistical output may reflect that *the active unit was not receiving any traffic on a VLAN* and when you
notice in the logs that a fail over occurred you may attribute it to the VLAN failsafe setting in your configuration.
The following is an example of errors you may see in the log if VLAN failsafe triggered:
```
01140029:5: HA vlan_fs vlan1 fails action is reboot.
01140029:5: HA vlan_fs vlan2 fails action is reboot.
```

> ConfigSync Failures

F5 introduced the Device Service Cluster (DSC) architecture in BIG-IP 11.x. DSC provides the framework for
ConfigSync, and other high-availability features, such as failover for BIG-IP device groups.

CMI: centralized management infrastructure (CMI).

CMI communication channel: the BIG-IP device signs x509 certificates for another BIG-IP
device that is in the local trust domain.

```
/config/ssl/ssl.crt/dtdi.crt
The dtdi.crt is the identity certificate that is
used by a device to validate its identity with
another device.
/config/ssl/ssl.key/dtdi.key
The dtdi.key is the corresponding key file
used by a device to validate its identity with
another device.

/config/ssl/ssl.crt/dtca.crt
The dtca.crt is the CA root certificate for
the trust network.
/config/ssl/ssl.key/dtca.key
The dtca.crt is the CA root key for the
trust network.
```

configsync-->>mcpd--->(6699)tmm(4353)----cmi channel----tmm(6699)--->mcpd--->>configsync

> To display the commit ID and the commit ID time stamps for the device group
```
BIG-IP 11.0.0 through 11.2.0:
watch_devicegroup_device

devices <devgroup [device cid.id cid.orig cid.time last_sync
20 21 sync_test bigip_a 32731 bigip_a.pslab.local 14:27:00 : :
20 21 sync_test bigip_b 1745 bigip_a.pslab.local 13:39:24 13:42:04
20 21 sync_test bigip_c 1745 bigip_a.pslab.local 13:39:24 13:42:04

//the one with higher CID ID and cid.time has the lastest config
```


> Packet flow in LTM

```mermaid
graph TD;
   A((ARP function)) --packet ingress--> B{packet filter on VLAN};
   B-->|RUNLE_INIT / FLOW_INT|C(TMM/AFM processing begins);
   C-->D{New TCP connection syn}
   
   D-->|ddos-Yes|d1[DDos func,sync_check]
   d2[3way successfully complete]-->|CLIENT_ACCEPTED|D
   D-->|ddos pass|E{Connection Table Entry?}


   E-->|Yes|e1{Virtual Server}

subgraph 1
   e1-->|No|e11[Address Translation,route to dst]
   e1-->|Yes|e2{Persistence Configured?}

   e2-->|No|e5
   e2-->|Yes|e3{persistence Table entry?}

   e3-->|No|e7[Entry createdn if possible]
   e3-->|Yes|e4[Destination NAT/PAT Occurs,not really]
   e7-->e4

   e4-->e5{Address Translation match?}
   e5-->|Yes|e6[Address Translation Occurs]
   e6-->e8[return to Pool member]
end


   E-->|No|F{Matching VS}


   F-->|Yes|f1{enabled on ingress vlan?}
   f1-->|Yes|e2


   f1-->|No|drop[Drop packet and send reset/icmp]
   F-->|No|G{Matching SNAT}
   G-->|Yes|f1

   G-->|No|H{Matching NAT}
   H-->f1

    
```

> about irule debug

```
[root@bigip12ve:Active:Standalone] tmp # which tclsh
/usr/bin/tclsh
[root@bigip12ve:Active:Standalone] tmp # tclsh
% set a 1
1
% puts $a
1
% 

write irule scripts:
#!/usr/bin/tclsh


https://devcentral.f5.com/articles/irules-101-15-tcl-list-handling-commands
http://www.tcl.tk/

```

# Section4 Q&A

> show the health of RAID array hard drives
```
root@(bigip12ve)(cfg-sync Standalone)(Active)(/Common)(tmos)# show /sys raid disk

-------------------------------------------------------------------
Sys::Raid::Disk
Name  Serial Number  Array   Array Status  Model
                     Member                 
-------------------------------------------------------------------
HD1   VMware-sda     no      undefined     VMware, VMware Virtual S
HD2   VMware-sdb     no      undefined     VMware, VMware Virtual S
```

```
root@(bigip12ve)(cfg-sync Standalone)(Active)(/Common)(tmos)# show /cm traffic-group 
                                                                                                                                                                                               
-------------------------------------------------------------
CM::Traffic-Group       
Name                      Device               Status  Next
                                                       Active
-------------------------------------------------------------
traffic-group-1           bigip12ve.localhost  active  false
traffic-group-local-only  - 

```

> Which two items could have caused the failover event?

The active LTM device in a high-availability (HA) pair performs a failover at the same time the network team
reports an outage of a switch on the network.Which two items could have caused the failover event? (Choose two.)

A.
a VLAN fail-safe setting

B.
a monitor on a pool in an HA group


> HA 

HA score
```
TG will failover to the device which is most available.
If A fail , which device will take over the TG from device A?
Dev A: 1TG with 10 vs
Dev B: 2 TG with 9 VS
Dev D: 1TG with 20 vs
Dev C: Standby, 0 TG


HA Score = Active Bonus + (Available member/Total member)*weight*T
// If Available member >= Threshold, T=1; else T=0


You have a HA pair with serial and network failover connection between them? What happens if network connection goes down?
– serial cable has precedence if NW and Serial failover are configured

//todo
```


> udp connection with/without persistence


> tmsh  manipulate routing table

> how ltm act TCP reset: no pool member available with/without monitor.
slow access in scenarios the pools without monitor.

> slow access after failover


> to failover
```
from cli:
 tmsh	run	/sys	failover	standby 

from web:
 From Main Page click on (Active) -> Force to Standby 
```

> tmsh run /util qkview

> nPath routing topology. You don't have acces to the backend server. How to fix it?

config the VIP ip address on the server loopback interface

> cookie
```
Set-Cookie: ......; expires=Thu, 09-Mar-2017 04:01:36 GMT; path=/; domain=.aaa.com
```

> Active lic ,Get dissor
```
ON THE MAIN MENU, CLICK SYSTEM > LICENSE.
CLICK RE-ACTIVATE.
FOR THE ACTIVATION METHOD SETTING, SELECT THE AUTOMATIC (REQUIRES OUTBOUND CONNECTIVITY) OPTION.
CLICK NEXT. 
THE BIG-IP SOFTWARE LICENSE RENEWS AUTOMATICALLY.
CLICK CONTINUE

```
> monitor

How to set up a monitor with receive disable string in each scenario? - receive disable string is not key sensitive 

| Receive String matches member or node | Receive Disable String matches member or node | State of pool, pool member, or node |
| ------------------------------------- | --------------------------------------------- | ----------------------------------- |
| Yes                                   | Yes                                           | Up (Enabled)                        |
| Yes                                   | No                                            | Up (Enabled)                        |
| No                                    | Yes                                           | Up (Disabled)                       |
| No                                    | No                                            | Down                                |



SOL8082: Overview of TCP connection setup for BIG-IP LTM virtual server types<very useful>

##### - Standard virtual server with Layer 7 functionality operates as follows: 
the three-way TCP handshake and initial data packet are processed on the client side of the connection before the BIG-IP LTM system initiates the TCP handshake on the server side of the connection.

```mermaid

sequenceDiagram

    participant c as Client
    participant l as LTM
    participant n as Node

    c-->>l:syn
    l-->>c:syn_ack
    c-->>l:ack

    Note over c,n: 3-way complete. ltm waits for data

    c-->>l:HTTP_GET
    l-->>c:ack

    Note over c,n: ltm choose pool member and init tcp

    l-->>n:syn
    n-->>l:syn_ack
    l-->>n:ack

    Note over c,n:data send to pool member

    l-->>n:HTTP_GET

```


##### - The Performance Layer4 virtual server packet-by-packet TCP behavior operates as follows: 
The initial SYN request is sent from the client to the BIG-IP LTM virtual server. The BIG-IP LTM system makes the load balancing decision and passes the SYN request to the pool member.

**The Performance Layer4 virtual server type uses the Fast L4 profile.**

```mermaid

sequenceDiagram

    participant c as Client
    participant l as LTM
    participant n as Node/Pool Member

    c-->>l:syn
    Note over c,n: ltm evaluates the packets,looking only at dest ip addr

    l-->>n:syn
    n-->>l:syn_ack

    l-->>c:syn_ack
    c-->>l:ack


    l-->>n:ack

    Note over c,n:client send data

    c-->>l:data
    l-->>n:data

```


##### - Performance HTTP virtual server
The Performance HTTP virtual server type uses the Fast HTTP profile. 
The Performance HTTP virtual server with the Fast HTTP profile is designed to speed up certain types of HTTP connections and reduce the number of connections opened to the back-end HTTP servers. This is accomplished 
by **combining features from the TCP, HTTP, and OneConnect profiles into a single profile** that is optimized for network performance. The Performance HTTP virtual server processes connections on a packet-by-packet basis and buffers only enough data to parse packet headers.

The Performance HTTP virtual server TCP behavior operates as follows: The BIG-IP system establishes server-side flows by opening TCP connections to the pool members. When a client makes a connection to the Performance HTTP virtual server, if an existing server-side flow to the pool member is idle, the BIG-IP LTM system marks the connection as non-idle and sends a client request over the connection.

If no idle server-side flow is found, the BIG-IP system creates a new server-side TCP connection and sends a client request over the connection.

> cmds
```
modify net self-allow defaults add/delete { tcp:22 } - Add service
Add Interface and service:
create net self x.x.x.101/32 vlan external allow-service default
create net self x.x.x.101/32 vlan external allow-service add/delete { tcp:22 }
Modify Interface:
modify net self x.x.x.101 address net self x.x.x.102/32 vlan external allow-service add/delete { tcp:22 }
modify net interface <interface_key> media <media_type> - Change speed
tmsh run /util qkview - Generate QKview
tmsh show /net interface all / default / all-properties - for all interfaces 
tmsh show /net interface <if number> all / default / all-properties – for given interface
tmsh run /util get-ccn-dossier - utility for displaying system information for dossier creation.
tmsh run /util get-dossier - utility for displaying system license dossier information.

```

> Which iRule statement demotes a virtual server from CMP?
//A. set ::foo 123 ?why?


> nPath and others
- [ ] ltm impl.pdf


## read links and lab todos

- [ ] https://support.f5.com/csp/article/K59616664
- [ ] https://support.f5.com/csp/article/K12531
- [ ] https://support.f5.com/csp/article/K411
- [ ] monitors lab
- [ ] tcpdump and ssldump lab
- [ ] npath details
